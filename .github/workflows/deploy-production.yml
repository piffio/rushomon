name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  wait-for-tests:
    name: Wait for Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Check test workflow status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'test.yml',
              head_sha: context.sha,
              status: 'completed'
            });

            if (runs.workflow_runs.length === 0) {
              throw new Error('Test workflow has not completed yet');
            }

            const testRun = runs.workflow_runs[0];
            if (testRun.conclusion !== 'success') {
              throw new Error(`Test workflow failed with conclusion: ${testRun.conclusion}`);
            }

            console.log('‚úÖ All tests passed');

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: wait-for-tests
    environment:
      name: production
      url: https://rushomon.workers.dev

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: '.'

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install wrangler and worker-build
        run: |
          npm install -g wrangler
          cargo install -q worker-build

      - name: Build Worker
        run: worker-build --release

      - name: Apply D1 Migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üìã Applying D1 migrations to production database..."
          wrangler d1 migrations apply rushomon --remote
          echo "‚úÖ Production migrations applied successfully"

      - name: Deploy to Production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          wrangler deploy \
            --account-id "$CLOUDFLARE_ACCOUNT_ID" \
            --api-token "$CLOUDFLARE_API_TOKEN"

      - name: Run Smoke Tests
        run: |
          DEPLOYMENT_URL="https://rushomon.workers.dev"
          
          echo "Testing production deployment at: $DEPLOYMENT_URL"
          
          # Wait for deployment to propagate
          sleep 5
          
          # Health check
          echo "Running health check..."
          if ! curl -f "$DEPLOYMENT_URL/api/health" 2>/dev/null; then
            echo "Health check endpoint not found, trying root..."
            curl -f "$DEPLOYMENT_URL/" || echo "Root endpoint also failed"
          fi
          
          # Create test link
          echo "Creating test link..."
          CREATE_RESPONSE=$(curl -s -X POST "$DEPLOYMENT_URL/api/links" \
            -H "Content-Type: application/json" \
            -d '{"destination_url": "https://example.com", "short_code": "prod'$RANDOM'"}')
          
          echo "Create response: $CREATE_RESPONSE"
          
          # Extract short code from response
          SHORT_CODE=$(echo "$CREATE_RESPONSE" | jq -r '.data.short_code // empty')
          
          if [ -n "$SHORT_CODE" ]; then
            echo "Created link with code: $SHORT_CODE"
            
            # Test redirect
            echo "Testing redirect..."
            curl -I "$DEPLOYMENT_URL/$SHORT_CODE" || echo "Redirect test failed"
          else
            echo "Warning: Could not extract short code from response"
          fi

      - name: Create Deployment Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deployment_url = 'https://rushomon.workers.dev';
            const commit_sha = context.sha.substring(0, 7);
            
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              description: `Production deployment of ${commit_sha}`,
              auto_merge: false,
              required_contexts: []
            });

      - name: Post Deployment Notification
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const commit_sha = context.sha.substring(0, 7);
            const commit_url = `${context.payload.repository.html_url}/commit/${context.sha}`;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚úÖ **Production Deployment Successful**\n\n` +
                    `**Commit**: [${commit_sha}](${commit_url})\n` +
                    `**URL**: https://rushomon.workers.dev\n` +
                    `**Time**: ${new Date().toISOString()}`
            });

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commit_sha = context.sha.substring(0, 7);
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚ùå **Production Deployment Failed**\n\n` +
                    `**Commit**: ${commit_sha}\n` +
                    `**Action**: [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n` +
                    `Please review the logs and rollback if necessary.`
            });
