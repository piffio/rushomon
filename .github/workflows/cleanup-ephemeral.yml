name: Cleanup Ephemeral Environment

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  cleanup:
    name: Cleanup Ephemeral Resources
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Extract PR Number
        id: pr_number
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Delete Cloudflare Pages Deployment
        id: delete_pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          PROJECT_NAME="rushomon-ui"
          BRANCH_NAME="pr-$PR_NUMBER"

          echo "Attempting to delete Pages deployment for branch: $BRANCH_NAME"

          # Get deployment ID for the branch
          DEPLOYMENTS_RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$PROJECT_NAME/deployments" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          DEPLOYMENT_ID=$(echo "$DEPLOYMENTS_RESPONSE" | jq -r ".result[] | select(.deployment_trigger.metadata.branch == \"$BRANCH_NAME\") | .id" | head -1)

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "âš ï¸  No Pages deployment found for branch: $BRANCH_NAME (may not have been created or already deleted)"
            echo "pages_result=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found deployment ID: $DEPLOYMENT_ID"

          # Delete the deployment
          DELETE_RESPONSE=$(curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$PROJECT_NAME/deployments/$DEPLOYMENT_ID" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Successfully deleted Pages deployment for branch: $BRANCH_NAME"
            echo "pages_result=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Failed to delete Pages deployment"
            echo "Response: $DELETE_RESPONSE"
            echo "pages_result=failed" >> $GITHUB_OUTPUT
            # Continue anyway - We want to delete all resources
          fi

      - name: Delete Ephemeral Worker
        id: delete_worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          WORKER_NAME="rushomon-pr-$PR_NUMBER"

          echo "Attempting to delete worker: $WORKER_NAME"

          # Delete the worker
          DELETE_RESPONSE=$(curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/workers/scripts/$WORKER_NAME" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Successfully deleted worker: $WORKER_NAME"
            echo "worker_result=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Failed to delete worker: $WORKER_NAME"
            echo "Response: $DELETE_RESPONSE"
            echo "worker_result=failed" >> $GITHUB_OUTPUT
            # Continue anyway - We want to delete all resources
          fi

      - name: Delete KV Namespace
        id: delete_kv
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          KV_NAME="URL_MAPPINGS_pr_$PR_NUMBER"

          echo "Attempting to delete KV namespace: $KV_NAME"

          # List namespaces to find the one matching our PR
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/storage/kv/namespaces" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          KV_ID=$(echo "$RESPONSE" | jq -r ".result[] | select(.title == \"$KV_NAME\") | .id" | head -1)

          if [ -z "$KV_ID" ]; then
            echo "âš ï¸  KV namespace not found: $KV_NAME (may have already been deleted)"
            echo "kv_result=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found KV namespace ID: $KV_ID"

          # Delete the KV namespace
          DELETE_RESPONSE=$(curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/storage/kv/namespaces/$KV_ID" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Successfully deleted KV namespace: $KV_NAME"
            echo "kv_result=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Failed to delete KV namespace"
            echo "Response: $DELETE_RESPONSE"
            echo "kv_result=failed" >> $GITHUB_OUTPUT
            # Continue anyway - We want to delete all resources
          fi

      - name: Delete D1 Database
        id: delete_d1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          DB_NAME="rushomon-pr-$PR_NUMBER"

          echo "Attempting to delete D1 database: $DB_NAME"

          # List databases to find the one matching our PR
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/d1/database" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          DB_ID=$(echo "$RESPONSE" | jq -r ".result[] | select(.name == \"$DB_NAME\") | .uuid // .id" | head -1)

          if [ -z "$DB_ID" ]; then
            echo "âš ï¸  Database not found: $DB_NAME (may have already been deleted)"
            echo "d1_result=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found database ID: $DB_ID"

          # Delete the database
          DELETE_RESPONSE=$(curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/d1/database/$DB_ID" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Successfully deleted D1 database: $DB_NAME"
            echo "d1_result=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Failed to delete D1 database"
            echo "Response: $DELETE_RESPONSE"
            echo "d1_result=failed" >> $GITHUB_OUTPUT
            # Continue anyway - We want to delete all resources
          fi

      - name: Post Cleanup Notification
        if: always()
        uses: thollander/actions-comment-pull-request@v3.0.1
        with:
          pr-number: ${{ steps.pr_number.outputs.pr_number }}
          message: |
            ğŸ§¹ **Ephemeral Environment Cleaned Up**

            Resources for PR #${{ steps.pr_number.outputs.pr_number }} cleanup summary:

            | Resource | Status |
            |----------|--------|
            | Pages Deployment `pr-${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_pages.outputs.pages_result == 'success' && 'âœ… Deleted' || steps.delete_pages.outputs.pages_result == 'failed' && 'âŒ Failed' || 'âš ï¸ Not found' }} |
            | Worker `rushomon-pr-${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_worker.outputs.worker_result == 'success' && 'âœ… Deleted' || steps.delete_worker.outputs.worker_result == 'failed' && 'âŒ Failed' || 'âš ï¸ Not found' }} |
            | KV Namespace `URL_MAPPINGS_pr_${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_kv.outputs.kv_result == 'success' && 'âœ… Deleted' || steps.delete_kv.outputs.kv_result == 'failed' && 'âŒ Failed' || 'âš ï¸ Not found' }} |
            | D1 Database `rushomon-pr-${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_d1.outputs.d1_result == 'success' && 'âœ… Deleted' || steps.delete_d1.outputs.d1_result == 'failed' && 'âŒ Failed' || 'âš ï¸ Not found' }} |

            *Cleanup completed automatically when PR was closed.*
