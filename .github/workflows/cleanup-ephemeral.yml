name: Cleanup Ephemeral Environment

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  cleanup:
    name: Cleanup Ephemeral Resources
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Extract PR Number
        id: pr_number
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Delete Cloudflare Pages Deployment
        id: delete_pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          PROJECT_NAME="rushomon-ui"
          BRANCH_NAME="pr-$PR_NUMBER"

          echo "üîç Cleanup scope: Only deployments for branch '$BRANCH_NAME' in project '$PROJECT_NAME'"
          echo "   Other PRs' deployments will NOT be affected"
          echo ""

          # Get all deployment IDs for the branch
          DEPLOYMENTS_RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$PROJECT_NAME/deployments" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          # Filter to only this PR's branch deployments
          DEPLOYMENT_IDS=$(echo "$DEPLOYMENTS_RESPONSE" | jq -r ".result[] | select(.deployment_trigger.metadata.branch == \"$BRANCH_NAME\") | .id")

          if [ -z "$DEPLOYMENT_IDS" ]; then
            echo "‚ö†Ô∏è  No Pages deployments found for branch '$BRANCH_NAME'"
            echo "   (Deployments may not have been created or already deleted)"
            echo "pages_result=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          DEPLOYMENT_COUNT=$(echo "$DEPLOYMENT_IDS" | grep -c '^' || echo "0")
          echo "‚úÖ Found $DEPLOYMENT_COUNT deployment(s) for branch '$BRANCH_NAME'"
          echo "   Proceeding to delete only these deployments..."
          echo ""

          # Delete each deployment with force=true to handle aliased deployments
          DELETED_COUNT=0
          FAILED_COUNT=0

          while IFS= read -r DEPLOYMENT_ID; do
            if [ -z "$DEPLOYMENT_ID" ]; then
              continue
            fi

            echo "Deleting deployment ID: $DEPLOYMENT_ID"

            DELETE_RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$PROJECT_NAME/deployments/$DEPLOYMENT_ID?force=true" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

            SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

            if [ "$SUCCESS" = "true" ]; then
              echo "  ‚úÖ Deleted deployment: $DEPLOYMENT_ID"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "  ‚ùå Failed to delete deployment: $DEPLOYMENT_ID"
              echo "  Response: $DELETE_RESPONSE"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          done <<< "$DEPLOYMENT_IDS"

          echo ""
          echo "Summary: Deleted $DELETED_COUNT deployment(s), Failed $FAILED_COUNT"

          if [ $DELETED_COUNT -gt 0 ] && [ $FAILED_COUNT -eq 0 ]; then
            echo "pages_result=success" >> $GITHUB_OUTPUT
          elif [ $DELETED_COUNT -gt 0 ] && [ $FAILED_COUNT -gt 0 ]; then
            echo "pages_result=partial" >> $GITHUB_OUTPUT
          else
            echo "pages_result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Delete Ephemeral Worker
        id: delete_worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          WORKER_NAME="rushomon-pr-$PR_NUMBER"

          echo "Attempting to delete worker: $WORKER_NAME"

          # Delete the worker
          DELETE_RESPONSE=$(curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/workers/scripts/$WORKER_NAME" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

          if [ "$SUCCESS" = "true" ]; then
            echo "‚úÖ Successfully deleted worker: $WORKER_NAME"
            echo "worker_result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Failed to delete worker: $WORKER_NAME"
            echo "Response: $DELETE_RESPONSE"
            echo "worker_result=failed" >> $GITHUB_OUTPUT
            # Continue anyway - We want to delete all resources
          fi

      - name: Delete KV Namespace
        id: delete_kv
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          KV_NAME="URL_MAPPINGS_pr_$PR_NUMBER"

          echo "Attempting to delete KV namespace: $KV_NAME"

          # List namespaces to find the one matching our PR
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/storage/kv/namespaces" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          KV_ID=$(echo "$RESPONSE" | jq -r ".result[] | select(.title == \"$KV_NAME\") | .id" | head -1)

          if [ -z "$KV_ID" ]; then
            echo "‚ö†Ô∏è  KV namespace not found: $KV_NAME (may have already been deleted)"
            echo "kv_result=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found KV namespace ID: $KV_ID"

          # Delete the KV namespace
          DELETE_RESPONSE=$(curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/storage/kv/namespaces/$KV_ID" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

          if [ "$SUCCESS" = "true" ]; then
            echo "‚úÖ Successfully deleted KV namespace: $KV_NAME"
            echo "kv_result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Failed to delete KV namespace"
            echo "Response: $DELETE_RESPONSE"
            echo "kv_result=failed" >> $GITHUB_OUTPUT
            # Continue anyway - We want to delete all resources
          fi

      - name: Delete D1 Database
        id: delete_d1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          DB_NAME="rushomon-pr-$PR_NUMBER"

          echo "Attempting to delete D1 database: $DB_NAME"

          # List databases to find the one matching our PR
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/d1/database" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          DB_ID=$(echo "$RESPONSE" | jq -r ".result[] | select(.name == \"$DB_NAME\") | .uuid // .id" | head -1)

          if [ -z "$DB_ID" ]; then
            echo "‚ö†Ô∏è  Database not found: $DB_NAME (may have already been deleted)"
            echo "d1_result=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found database ID: $DB_ID"

          # Delete the database
          DELETE_RESPONSE=$(curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/d1/database/$DB_ID" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

          if [ "$SUCCESS" = "true" ]; then
            echo "‚úÖ Successfully deleted D1 database: $DB_NAME"
            echo "d1_result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Failed to delete D1 database"
            echo "Response: $DELETE_RESPONSE"
            echo "d1_result=failed" >> $GITHUB_OUTPUT
            # Continue anyway - We want to delete all resources
          fi

      - name: Post Cleanup Notification
        if: always()
        uses: thollander/actions-comment-pull-request@v3.0.1
        with:
          pr-number: ${{ steps.pr_number.outputs.pr_number }}
          message: |
            üßπ **Ephemeral Environment Cleaned Up**

            Resources for PR #${{ steps.pr_number.outputs.pr_number }} cleanup summary:

            | Resource | Status |
            |----------|--------|
            | Pages Deployment `pr-${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_pages.outputs.pages_result == 'success' && '‚úÖ Deleted' || steps.delete_pages.outputs.pages_result == 'partial' && '‚ö†Ô∏è Partially deleted' || steps.delete_pages.outputs.pages_result == 'failed' && '‚ùå Failed' || '‚ö†Ô∏è Not found' }} |
            | Worker `rushomon-pr-${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_worker.outputs.worker_result == 'success' && '‚úÖ Deleted' || steps.delete_worker.outputs.worker_result == 'failed' && '‚ùå Failed' || '‚ö†Ô∏è Not found' }} |
            | KV Namespace `URL_MAPPINGS_pr_${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_kv.outputs.kv_result == 'success' && '‚úÖ Deleted' || steps.delete_kv.outputs.kv_result == 'failed' && '‚ùå Failed' || '‚ö†Ô∏è Not found' }} |
            | D1 Database `rushomon-pr-${{ steps.pr_number.outputs.pr_number }}` | ${{ steps.delete_d1.outputs.d1_result == 'success' && '‚úÖ Deleted' || steps.delete_d1.outputs.d1_result == 'failed' && '‚ùå Failed' || '‚ö†Ô∏è Not found' }} |

            *Cleanup completed automatically when PR was closed.*
