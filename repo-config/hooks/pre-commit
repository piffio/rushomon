#!/bin/bash

# Enhanced pre-commit hook for Rushomon
# Uses configuration from repo-config/config/

set -euo pipefail

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Load configuration
CONFIG_DIR="$REPO_ROOT/repo-config/config"

if [ -f "$CONFIG_DIR/default.sh" ]; then
    source "$CONFIG_DIR/default.sh"
else
    echo "‚ùå Configuration file not found: $CONFIG_DIR/default.sh"
    echo "Please run: ./repo-config/scripts/setup.sh"
    exit 1
fi

# Load user overrides if they exist
if [ -f "$CONFIG_DIR/user.sh" ]; then
    source "$CONFIG_DIR/user.sh"
fi

# Helper functions
log_verbose() {
    if [ "${PRE_COMMIT_VERBOSE:-true}" = true ]; then
        echo "$@"
    fi
}

check_tool() {
    local tool="$1"
    local required="$2"
    local install_msg="$3"
    
    if ! command -v "$tool" >/dev/null 2>&1; then
        if [ "$required" = true ]; then
            echo "‚ùå Required tool '$tool' not found"
            echo "üí° $install_msg"
            return 1
        else
            log_verbose "‚ö†Ô∏è  Optional tool '$tool' not found (install: $install_msg)"
            return 0
        fi
    fi
    log_verbose "‚úÖ Tool '$tool' found"
    return 0
}

run_check() {
    local enabled_var="$1"
    local command_var="$2"
    local required_var="$3"
    local error_msg_var="$4"
    local check_name="$5"
    
    local enabled="${!enabled_var:-false}"
    local command="${!command_var}"
    local required="${!required_var:-false}"
    local error_msg="${!error_msg_var:-Check failed}"
    
    if [ "$enabled" = true ]; then
        log_verbose "üîç Running $check_name..."
        echo "üß™ Running $check_name..."
        
        # Special handling for code formatting
        if [ "$check_name" = "code formatting" ]; then
            run_formatting_check "$command" "$error_msg" "$required"
            return $?
        fi

        if ! eval "$command"; then
            echo ""
            echo "‚ùå $error_msg"
            echo ""
            
            if [ "$required" = true ]; then
                echo "To skip this hook (not recommended):"
                echo "  git commit --no-verify"
                echo ""
                exit 1
            else
                echo "‚ö†Ô∏è  Continuing commit (non-critical check failed)"
                echo ""
            fi
        else
            log_verbose "‚úÖ $check_name passed"
        fi
    else
        log_verbose "‚è≠Ô∏è  Skipping $check_name (disabled)"
    fi
}

run_formatting_check() {
    local check_command="$1"
    local error_msg="$2"
    local required="$3"
    local auto_format_and_stage="${AUTO_FORMAT_AND_STAGE:-false}"

    # Check if formatting is needed
    if ! eval "$check_command"; then
        echo ""
        echo "üîß Formatting issues detected."

        if [ "$auto_format_and_stage" = true ]; then
            echo "ü§ñ Auto-formatting and staging changes..."
            cargo fmt

            # Show what changed
            local changed_files
            changed_files=$(git diff --name-only)

            if [ -n "$changed_files" ]; then
                echo "üìù Files formatted and staged:"
                echo "$changed_files" | sed 's/^/   - /'

                # Stage the formatted files
                git add $changed_files

                echo ""
                echo "‚úÖ Formatting applied and changes staged automatically"
                echo "üí° To disable this behavior, set AUTO_FORMAT_AND_STAGE=false in repo-config/config/user.sh"
            else
                echo "‚ÑπÔ∏è  No files were changed by formatting"
            fi
        else
            echo "üîß Auto-formatting files..."
            cargo fmt

            # Show what changed
            local changed_files
            changed_files=$(git diff --name-only)

            if [ -n "$changed_files" ]; then
                echo ""
                echo "üìù The following files were formatted:"
                echo "$changed_files" | sed 's/^/   - /'
                echo ""
                echo "‚ùå Commit aborted - please review the formatting changes"
                echo ""
                echo "üí° Next steps:"
                echo "   1. Review the changes above"
                echo "   2. Stage the formatted files:"
                echo "      git add ."
                echo "   3. Retry your commit:"
                echo "      git commit"
                echo ""
                echo "üí° To enable auto-format and stage, set AUTO_FORMAT_AND_STAGE=true in repo-config/config/user.sh"
            else
                echo "‚ÑπÔ∏è  No files were changed by formatting"
                return 0
            fi
        fi

        echo ""
        if [ "$required" = true ]; then
            echo "To skip this hook (not recommended):"
            echo "  git commit --no-verify"
            echo ""
            exit 1
        fi
    else
        log_verbose "‚úÖ Code formatting is correct"
        echo "‚úÖ Code formatting is correct"
    fi
}

# Main execution
main() {
    echo "üîç Running pre-commit checks..."
    echo ""
    
    # Check required tools
    log_verbose "üîß Checking tool availability..."
    
    if ! check_tool "cargo" "$CARGO_REQUIRED" "$CARGO_INSTALL_MSG"; then
        exit 1
    fi
    
    # Optional tools
    if [ "$CODE_FORMATTING_ENABLED" = true ] && [ "$CODE_FORMATTING_REQUIRED" = true ]; then
        check_tool "rustfmt" true "$RUSTFMT_INSTALL_MSG"
    fi
    
    if [ "$CLIPPY_ENABLED" = true ] && [ "$CLIPPY_REQUIRED" = true ]; then
        check_tool "cargo-clippy" true "$CLIPPY_INSTALL_MSG"
    fi
    
    echo ""
    
    # Run checks
    run_check "UNIT_TESTS_ENABLED" "UNIT_TESTS_COMMAND" "UNIT_TESTS_REQUIRED" "UNIT_TESTS_ERROR_MSG" "unit tests"
    run_check "CODE_FORMATTING_ENABLED" "CODE_FORMATTING_COMMAND" "CODE_FORMATTING_REQUIRED" "CODE_FORMATTING_ERROR_MSG" "code formatting"
    run_check "CLIPPY_ENABLED" "CLIPPY_COMMAND" "CLIPPY_REQUIRED" "CLIPPY_ERROR_MSG" "clippy linting"
    
    echo ""
    echo "‚úÖ All enabled checks passed! Proceeding with commit..."
}

# Run main function
main "$@"
